# Обработка месячных данных (YEAR_SPOD_TOP_Month)

## Формулировка задачи и техническое задание

### Задача
Создать систему для автоматической обработки месячных данных из Excel файлов, расположенных в подкаталогах `OD`, `RA` и `PS` внутри каталога `IN`. Система должна:

1. Загружать файлы из всех подкаталогов с учетом настроек для каждой группы
2. Собирать уникальные табельные номера из всех файлов
3. Определять приоритетные данные для каждого табельного номера (ОД > RA > PS, 12 месяц > 11 месяц > ...)
4. Формировать сводный Excel файл с суммированием показателей по каждому файлу
5. Применять форматирование к итоговому файлу согласно требованиям

### Техническое задание

**Входные данные:**
- Каталог `IN` с подкаталогами: `OD`, `RA`, `PS`
- В каждом подкаталоге 12 Excel файлов с месячными данными в формате `M-{номер}_{группа}.xlsx` (например, `M-1_OD.xlsx`, `M-2_RA.xlsx`)
- Номер месяца: 1 (январь) до 12 (декабрь)
- Каждый файл содержит колонки: Табельный номер, Короткое ТБ, Полное ГОСБ, ИНН, ФИО, Факт

**Выходные данные:**
- Excel файл со сводными данными, содержащий:
  - **Лист "RAW"** (опционально, если `ENABLE_RAW_SHEETS = True`): Сырые данные после фильтрации - уникальные комбинации ТН+ТБ+ФИО+ИНН с суммами показателей по каждому файлу. Если данных больше 900 000 строк, создаются дополнительные листы RAW_2, RAW_3 и т.д.
  - **Лист "Исходник"**: Исходные отфильтрованные данные - уникальные табельные номера, ТБ, ФИО (из файла с наивысшим приоритетом), колонки с суммами показателей из каждого файла
  - **Лист "Расчет"**: Те же базовые колонки (Табельный, ТБ, ФИО), расчетные колонки по месяцам с различными типами расчетов (как есть, прирост по 2 месяцам, прирост по трем периодам)
  - **Лист "Нормализация"**: Нормализованные значения показателей для расчета лучшего месяца (вариант 3)
  - **Лист "Места и выбор"**: Score для каждого месяца, горизонтальные ранги по месяцам и колонка "Лучший месяц" с номером месяца (или месяцев через запятую)
  - **Лист "Итог"**: Итоговые данные с выбором месяца и значениями показателей в этом месяце, включая колонку "Количество уникальных ИНН"
  - **Лист "Статистика"** (опционально, если `ENABLE_STATISTICS = True`): Подробная статистика обработки данных - количество КМ, клиентов, статистика по файлам, правилам фильтрации, выбору табельных номеров
  - **Листы "Детально_{табельный_номер}"** (опционально, если `DEBUG_TAB_NUMBER` указан): Детальные листы с подробной статистикой по каждому табельному номеру из списка `DEBUG_TAB_NUMBER`. Каждый лист содержит несколько таблиц:
    - Исходные файлы: какие клиенты (ИНН) с какими ТБ были в каждом файле, варианты ТБ, выбранный вариант
    - Данные после схлопывания (RAW): итоговые суммы по файлам для каждого ИНН
    - Результаты расчетов: факт, прирост по 2м, прирост по 3м по месяцам
    - Нормализация: нормализованные значения OD, RA, PS по месяцам
    - Score и выбор месяца: Score по месяцам, лучший месяц
    - Итоговая статистика: сводная информация

**Требования к форматированию:**
- Режим форматирования задается параметром `FORMATTING_MODE`:
  - **"full"** (по умолчанию): Полное форматирование всех листов
  - **"off"**: Форматирование выключено (листы формируются, но не переформатируются, кроме ТН и ИНН - их форматы всегда работают)
  - **"simple"**: Упрощенное форматирование (только ТН, ИНН, ФИО, ТБ, ГОСБ и заголовок, не форматируем данные показателей и расчетов)
- Первая строка и первые 3 колонки (Табельный, ТБ, ФИО) зафиксированы на основных листах
- Заголовки жирным шрифтом, размер 12, центрированы
- Ширина колонок: минимум 15, максимум 150
- Подбор ширины по содержимому
- Перенос текста по словам
- Автофильтр включен
- Табельный номер: формат 8 знаков с лидирующими нулями (например, `00000123`) - **всегда форматируется независимо от режима**
- ИНН: текстовый формат для сохранения лидирующих нулей - **всегда форматируется независимо от режима**
- Числовые колонки (только в режиме "full"): формат с разделителем разрядов и двумя знаками после запятой (например, `1 234 567,89`)
- Колонки Score и нормализованных значений (только в режиме "full"): формат с разделителем разрядов и двумя знаками после запятой (например, `0,85`)
- Колонки ранга (места) (только в режиме "full"): формат целого числа с разделителем разрядов без дробной части (например, `1`)
- Колонка "Лучший месяц": текстовый формат (например, `3` или `3, 5`)
- Порядок колонок: базовые (Табельный, ТБ, ФИО), затем по группам и месяцам (OD M-1...M-12, RA M-1...M-12, PS M-1...M-12)
- Именование колонок на листе "Расчет": формат "OD (M-1) [факт]" или "OD (M-2) [M-2→M-1]" или "OD (M-3) [M-3-2*M-2+M-1]"
- Именование колонок на листе "Нормализация": формат "OD_norm (M-1)", "RA_norm (M-1)" и т.д.
- Именование колонок на листе "Места и выбор": формат "Score (M-1)", "Место (M-1)" и т.д.
- Для RAW листов используется упрощенное форматирование (только заголовки) для ускорения обработки больших объемов данных

## Подробное описание решения

### Архитектура системы

Все компоненты системы находятся в одном файле `main.py`:

1. **Настройки приложения** - пути к каталогам и уровень логирования
2. **Конфигурация загрузки файлов** - настройки по умолчанию для групп OD, RA, PS и пофайловые настройки
3. **Модуль логирования** - система логирования с уровнями INFO и DEBUG
4. **Модуль обработки файлов** - загрузка и обработка Excel файлов
5. **Модуль форматирования Excel** - форматирование итоговых Excel файлов
6. **Основная функция** - координация всех этапов обработки

### Алгоритм работы

1. **Загрузка файлов (параллельно для всех групп):**
   - Все группы (OD, RA, PS) загружаются параллельно одновременно
   - Внутри каждой группы файлы также загружаются параллельно (до 8 потоков)
   - Сканирование подкаталогов OD, RA, PS
   - Загрузка каждого Excel файла с применением конфигурации группы
   - Фильтрация колонок согласно настройкам
   - Проверка обязательных полей
   - Сбор статистики по каждому файлу (DEBUG): количество строк, уникальных клиентов (ИНН), уникальных табельных номеров
   - Вывод сводной статистики (INFO): общий объем данных в строках, уникальных клиентах и табельных номерах

2. **Сбор уникальных табельных номеров:**
   - Извлечение всех табельных номеров из всех файлов (оптимизировано: используется `itertuples()` вместо `iterrows()`)
   - Нормализация табельных номеров выполняется один раз для всего DataFrame
   - **В каждом файле табельные номера должны быть уникальны:** если в файле есть несколько строк с одним табельным номером, берется первая строка (дубликаты удаляются)
   - **Алгоритм поиска ТБ:**
     - Поиск выполняется в порядке приоритета: OD -> RA -> PS, декабрь (M-12) -> ноябрь (M-11) -> ... -> январь (M-1)
     - Для каждого табельного номера берется **ПЕРВЫЙ найденный** ТБ
     - Если у табельного номера несколько разных ТБ, выбирается вариант с максимальной суммой показателя
     - Если табельный номер уже найден в файле с более высоким приоритетом, он **НЕ обновляется** - остается ранее найденный ТБ
     - В логах выводится информация о всех найденных вариантах ТБ с суммами и выбранном варианте
   - Результат: каждый табельный номер встречается в итоговом списке только один раз
   - Кэширование номеров месяцев из имен файлов для ускорения обработки

3. **Формирование сводных данных (параллельное создание индексов):**
   - Предварительная индексация: для каждого файла создается словарь `{tab_number: sum}` один раз (параллельно для всех файлов)
   - Для каждого уникального табельного номера используется предварительно созданный индекс вместо фильтрации DataFrame
   - Форматирование табельного номера: 8 знаков с лидирующими нулями
   - Сбор сумм показателей из каждого файла (оптимизировано: используется `groupby()` для агрегации)
   - Создание структуры: строки = табельные номера, колонки = файлы
   - Упорядочивание колонок: базовые колонки, затем по группам (OD, RA, PS) и месяцам (M-1, M-2, ..., M-12)

3.5. **Подготовка сырых данных для листа RAW (параллельная обработка файлов):**
   - Все файлы обрабатываются параллельно независимо от группы
   - Для каждого файла создаются уникальные комбинации ТН+ТБ+ФИО+ИНН с суммой показателя
   - Данные объединяются в сводную таблицу с колонками по группам и месяцам

4. **Формирование расчетных данных (последовательно):**
   - Копирование базовых колонок (Табельный, ТБ, ФИО)
   - Расчет значений по месяцам согласно типу расчета:
     - Тип 1: "Как есть" - просто сумма данных (аналог первого листа)
     - Тип 2: "Прирост по 2 месяцам" - текущий месяц минус предыдущий месяц
     - Тип 3: "Прирост по трем периодам" - М-N = М-N - 2*М-(N-1) + М-(N-2)
   - Обработка первых месяцев согласно правилам для каждого типа расчета
   - Переименование колонок в понятный формат: "OD (M-1) [факт]", "OD (M-2) [M-2→M-1]" и т.д.

5. **Нормализация показателей и расчет лучшего месяца (вариант 3, параллельная обработка):**
   
   **Общая схема:**
   - Нормализация выполняется отдельно для каждого показателя (OD, RA, PS) и для каждого КМ горизонтально по месяцам
   - Все группы (OD, RA, PS) нормализуются параллельно одновременно (3 потока)
   - Учет направления показателя (MAX - большее лучше, MIN - меньшее лучше) при нормализации
   - Расчет взвешенного Score для каждого месяца на основе нормализованных значений (параллельно для всех месяцев)
   - Определение горизонтального ранга по Score для каждого КМ
   - Выбор лучшего месяца (месяц с рангом 1 по Score)
   
   **Процесс нормализации:**
   
   **Шаг 1: Подготовка данных**
   Для каждого показателя (OD, RA, PS) собираются все значения по месяцам для конкретного КМ:
   ```
   Для КМ #12345:
   OD: M-1 = 100, M-2 = 150, M-3 = 120, M-4 = 180
   RA: M-1 = 50,  M-2 = 60,  M-3 = 55,  M-4 = 70
   PS: M-1 = 200, M-2 = 250, M-3 = 220, M-4 = 300
   ```
   
   **Шаг 2: Определение направления показателя**
   Каждый показатель имеет направление, задаваемое в конфигурации через параметр `indicator_direction`:
   - **MAX** - большее значение лучше (например, доходы)
   - **MIN** - меньшее значение лучше (например, расходы)
   
   **Шаг 3: Нахождение минимума и максимума**
   Для каждого КМ и каждого показателя находятся:
   - **min** - минимальное значение среди всех месяцев (игнорируя NaN)
   - **max** - максимальное значение среди всех месяцев (игнорируя NaN)
   - **range** = max - min (диапазон значений)
   
   **Пример:**
   ```
   Для КМ #12345, показатель OD:
   min = 100 (M-1)
   max = 180 (M-4)
   range = 180 - 100 = 80
   ```
   
   **Шаг 4: Нормализация значений**
   
   **Формула для MAX (больше = лучше):**
   ```
   normalized = (value - min) / range
   ```
   Результат: значение от 0 до 1, где 0 = минимальное значение (худший месяц), 1 = максимальное значение (лучший месяц)
   
   **Формула для MIN (меньше = лучше):**
   ```
   normalized = (max - value) / range
   ```
   Результат: значение от 0 до 1, где 0 = максимальное значение (худший месяц), 1 = минимальное значение (лучший месяц)
   
   **Пример для MAX:**
   ```
   OD: M-1 = (100 - 100) / 80 = 0.0
       M-2 = (150 - 100) / 80 = 0.625
       M-3 = (120 - 100) / 80 = 0.25
       M-4 = (180 - 100) / 80 = 1.0
   ```
   
   **Шаг 5: Обработка особых случаев**
   - **Только один месяц с данными:** этот месяц получает 1.0, остальные 0.0
   - **Все значения одинаковы:** все месяцы получают 0.5
   - **Деление на ноль (range = 0):** все месяцы получают 0.5
   
   **Расчет Score и мест:**
   
   **Шаг 1: Расчет Score для каждого месяца**
   После нормализации для каждого месяца рассчитывается **Score** - взвешенная сумма нормализованных значений:
   ```
   Score (M-N) = OD_norm (M-N) × weight_od + RA_norm (M-N) × weight_ra + PS_norm (M-N) × weight_ps
   ```
   
   **Веса по умолчанию:**
   - `weight_od = 0.33` (33%)
   - `weight_ra = 0.33` (33%)
   - `weight_ps = 0.34` (34%)
   
   **Пример:**
   ```
   Для КМ #12345, месяц M-2:
   OD_norm (M-2) = 0.625
   RA_norm (M-2) = 0.5
   PS_norm (M-2) = 0.6
   
   Score (M-2) = 0.625 × 0.33 + 0.5 × 0.33 + 0.6 × 0.34
              = 0.20625 + 0.165 + 0.204
              = 0.57525
   ```
   
   **Шаг 2: Расчет ранга (места) для каждого месяца**
   Для каждого КМ рассчитывается ранг каждого месяца на основе Score:
   - Используется `rank()` с параметрами: `method='min'`, `ascending=False` (большее значение Score = лучшее место)
   - Результат: ранг от 1 (лучший) до N (худший)
   
   **Пример:**
   ```
   Для КМ #12345:
   Score (M-1) = 0.2  → Место = 4
   Score (M-2) = 0.575 → Место = 2
   Score (M-3) = 0.35  → Место = 3
   Score (M-4) = 0.8   → Место = 1
   
   Лучший месяц: M-4 (ранг 1)
   ```
   
   **Шаг 3: Определение лучшего месяца**
   Лучший месяц - это месяц(ы) с рангом 1 (наивысший Score).
   
   Если несколько месяцев имеют ранг 1 (одинаковый Score), применяется дополнительная логика:
   - Если месяцы подряд идут (например, 2, 3, 4) и значения OD, RA, PS одинаковые: выбирается только первый месяц из последовательности
   - Если есть несколько групп подряд идущих месяцев: выбирается первый месяц из каждой группы
   - Если все месяцы разные: выбираются все месяцы с рангом 1
   
   **Полный пример расчета:**
   
   **Исходные данные для КМ #12345:**
   | Месяц | OD      | RA      | PS      |
   |-------|---------|---------|---------|
   | M-1   | 100.0   | 50.0    | 200.0   |
   | M-2   | 150.0   | 60.0    | 250.0   |
   | M-3   | 120.0   | 55.0    | 220.0   |
   | M-4   | 180.0   | 70.0    | 300.0   |
   
   **Нормализация OD (MAX):**
   - min = 100.0, max = 180.0, range = 80.0
   - OD_norm (M-1) = 0.0, OD_norm (M-2) = 0.625, OD_norm (M-3) = 0.25, OD_norm (M-4) = 1.0
   
   **Нормализация RA (MAX):**
   - min = 50.0, max = 70.0, range = 20.0
   - RA_norm (M-1) = 0.0, RA_norm (M-2) = 0.5, RA_norm (M-3) = 0.25, RA_norm (M-4) = 1.0
   
   **Нормализация PS (MAX):**
   - min = 200.0, max = 300.0, range = 100.0
   - PS_norm (M-1) = 0.0, PS_norm (M-2) = 0.5, PS_norm (M-3) = 0.2, PS_norm (M-4) = 1.0
   
   **Расчет Score:**
   - Score (M-1) = 0.0 × 0.33 + 0.0 × 0.33 + 0.0 × 0.34 = 0.0
   - Score (M-2) = 0.625 × 0.33 + 0.5 × 0.33 + 0.5 × 0.34 = 0.54125
   - Score (M-3) = 0.25 × 0.33 + 0.25 × 0.33 + 0.2 × 0.34 = 0.233
   - Score (M-4) = 1.0 × 0.33 + 1.0 × 0.33 + 1.0 × 0.34 = 1.0
   
   **Расчет ранга:**
   - M-4: Score = 1.0 → Место = 1 (лучший)
   - M-2: Score = 0.54125 → Место = 2
   - M-3: Score = 0.233 → Место = 3
   - M-1: Score = 0.0 → Место = 4
   
   **Результат:** Лучший месяц = **M-4**

8. **Сбор статистики (если ENABLE_STATISTICS = True):**
   - Сбор статистики по каждому файлу: исходное количество строк, удалено по drop_rules, оставлено по in_rules
   - Статистика выбора табельных номеров: сколько было вариантов ТБ, сколько выбрано, детальная информация о вариантах с суммами
   - Итоговая статистика: количество КМ, клиентов, распределение по ТБ
   - Формирование листа "Статистика" с подробной аналитикой
   - Вывод статистики в лог

9. **Сохранение и форматирование:**
   - Сохранение данных в Excel на 5 основных листов + лист "Статистика" (если включен)
   - Применение форматирования к заголовкам и ячейкам на всех листах
   - Фиксация первой строки и первых 4 колонок (до ФИО включительно) на основных листах
   - Форматирование табельного номера: текстовый формат для сохранения лидирующих нулей
   - Форматирование числовых колонок: разделитель разрядов и два знака после запятой
   - Форматирование листа "Статистика": заголовки разделов, таблицы, числа
   - Настройка ширины колонок и автофильтра

## Полный список переменных и функций

### Настройки приложения

Все настройки находятся в начале файла `main.py`:

```python
INPUT_DIR = "IN"      # Каталог с входными данными
OUTPUT_DIR = "OUT"     # Каталог для выходных файлов
LOG_DIR = "log"        # Каталог для логов
LOG_LEVEL = "DEBUG"    # Уровень логирования: DEBUG (в файлы) - детальное, INFO (в консоль) - верхнеуровневое
LOG_THEME = "processor"  # Тема логов

# Параметры детального логирования
DEBUG_TAB_NUMBER: Optional[List[str]] = None  # Список табельных номеров для детального логирования (например, ["12345678", "87654321"] или None для отключения)
# Если указан список, в лог будет записываться подробная информация о всех операциях с этими табельными номерами
# Также будут созданы детальные листы Excel с подробной статистикой по каждому табельному номеру
# Если список пустой или None, детальное логирование и детальные листы отключены

# Параметр выбора режима данных
DATA_MODE: str = "TEST"  # "TEST" - тестовые данные, "PROM" - пром данные
# Определяет, какие columns использовать из конфигурации (columns_test или columns_prom)

# Триггер для формирования RAW листов
ENABLE_RAW_SHEETS: bool = False  # True - формировать RAW листы, False - не формировать (по умолчанию выключено)
# Если False, RAW листы не создаются и не выводятся в файл
# Если False, подготовка RAW данных полностью пропускается для экономии времени
# ВАЖНО: При ENABLE_RAW_SHEETS=False колонка "Количество уникальных ИНН" в листе "Итог" будет заполнена нулями

# Триггер для форматирования листов
FORMATTING_MODE: str = "full"  # "full", "off", "simple"
# "full" - полное форматирование (как сейчас, по умолчанию)
# "off" - форматирование выключено (листы формируются, но не переформатируются, кроме ТН и ИНН - их форматы всегда работают)
# "simple" - упрощенное форматирование (только ТН, ИНН, ФИО, ТБ, ГОСБ и заголовок, не форматируем данные показателей и расчетов)
```

### Класс FileConfig
Конфигурация для отдельного файла.

**Поля:**
- `columns: Optional[List[str]]` - Колонки для загрузки (None = использовать настройки группы)
- `exclude_fields: List[str]` - Поля для исключения
- `required_fields: List[str]` - Обязательные поля
- `custom_settings: Dict[str, Any]` - Дополнительные настройки

**Пример использования:**
```python
file_config = FileConfig(
    columns=["Табельный", "ТБ", "ГОСБ", "ФИО", "Показатель"],
    exclude_fields=["Примечание"],
    required_fields=["Табельный", "ФИО"]
)
```

### Класс DefaultsConfig
Настройки по умолчанию для группы файлов. Все эти настройки используются, если в FileItem не указаны индивидуальные значения.

**Поля:**
- `columns: List[Dict[str, str]]` - Колонки по умолчанию (маппинг source -> alias)
- `drop_rules: List[DropRule]` - Правила удаления строк по умолчанию
- `in_rules: List[IncludeRule]` - Правила включения строк по умолчанию
- `tab_number_column: str` - Название колонки с табельным номером (после маппинга)
- `tb_column: str` - Название колонки с ТБ (после маппинга)
- `gosb_column: str` - Название колонки с ГОСБ (после маппинга) - оставлено для обратной совместимости, не используется в обработке
- `fio_column: str` - Название колонки с ФИО (после маппинга)
- `indicator_column: str` - Название колонки с показателем (после маппинга)
- `header_row: Optional[int]` - Номер строки с заголовками
- `skip_rows: int` - Количество строк для пропуска в начале файла
- `skip_footer: int` - Количество строк для пропуска в конце файла
- `sheet_name: Optional[str]` - Название листа для чтения
- `sheet_index: Optional[int]` - Номер листа для чтения
- `calculation_type: int` - Тип расчета для листа "Расчет" (1, 2, 3)
- `first_month_value: str` - Значение для первого месяца при расчете типа 2 ("self" или "zero")
- `three_periods_first_months: str` - Правила для первого и второго месяца при расчете типа 3
- `indicator_direction: str` - Направление показателя для нормализации ("MAX" - большее лучше, "MIN" - меньшее лучше)
- `weight: float` - Вес для данной группы при расчете Score (по умолчанию 0.33)
  - В каждом разделе (OD, RA, PS) задается только свой вес
  - В разделе OD: weight=0.33 (вес для группы OD)
  - В разделе RA: weight=0.33 (вес для группы RA)
  - В разделе PS: weight=0.34 (вес для группы PS)

### Класс FileItem
Элемент конфигурации для одного файла.

**Поля:**
- `key: str` - Ключ файла (для идентификации)
- `label: str` - Подпись для логов
- `file_name: str` - Имя файла в каталоге IN
- `sheet: Optional[str]` - Название листа (если None, используется default_sheet из группы)
- `columns: List[Dict[str, str]]` - Колонки для этого файла (если пустой [], используются из defaults)
- `filters: Dict[str, Any]` - Фильтры для этого файла (drop_rules, in_rules)
- `calculation_type: Optional[int]` - Тип расчета для листа "Расчет" (1, 2, 3 или None - использовать default)
- `first_month_value: Optional[str]` - Значение для первого месяца при расчете типа 2 ("self", "zero" или None - использовать default)
- `three_periods_first_months: Optional[str]` - Правила для первого и второго месяца при расчете типа 3 (или None - использовать default)

**Приоритет настроек:** Если параметры расчета указаны в FileItem, они имеют приоритет над значениями из defaults.

### Класс GroupConfig
Конфигурация для группы файлов (OD, RA, PS).

**Поля:**
- `name: str` - Название группы
- `default_sheet: str` - Лист по умолчанию
- `items: List[FileItem]` - Список файлов (items)
- `defaults: DefaultsConfig` - Настройки по умолчанию для этой группы

### Класс ConfigManager
Менеджер конфигурации для управления настройками загрузки файлов.

**Методы:**
- `get_config_for_file(group_name: str, file_name: str) -> Dict[str, Any]` - Получает конфигурацию для конкретного файла
- `add_file_config(group_name: str, file_pattern: str, file_config: FileConfig) -> None` - Добавляет пофайловую конфигурацию
- `get_group_config(group_name: str) -> GroupConfig` - Получает конфигурацию группы

**Пример использования:**
```python
# Получить конфигурацию для файла
config = config_manager.get_config_for_file("OD", "file_12.xlsx")

# Добавить пофайловую конфигурацию
custom_config = FileConfig(
    columns=["Табельный", "ТБ", "ФИО"],
    exclude_fields=["КМ"]
)
config_manager.add_file_config("OD", "special_file.xlsx", custom_config)
```

### Класс Logger
Класс для настройки и управления логированием.

**Особенности логирования:**
- **Файловый обработчик:** Настроен на уровень DEBUG - записывает все логи (INFO, DEBUG, WARNING, ERROR) в файлы
- **Консольный обработчик:** Настроен на уровень INFO - выводит только верхнеуровневую информацию (INFO, WARNING, ERROR), DEBUG не выводится в консоль
- **Формат логов в файлах:** `дата время - [уровень] - сообщение [class: <имя класса> | def: <имя функции>]`
- **Формат логов в консоли:** `дата время - [уровень] - сообщение`
- **Имена файлов логов:** `{уровень}_{тема}_{годмесяцдень_часминуты}.log` (например, `DEBUG_processor_20251209_1345.log`)

**Разделение уровней:**
- **INFO:** Верхнеуровневая информация - начало/конец этапов, итоговые результаты (сколько обработано, создано), важные события
- **DEBUG:** Детальная информация - информация о группах и месяцах, создание индексов, прогресс обработки, параметры расчетов, детали проверок, информация о каждой колонке

**Методы:**
- `__init__(log_dir: str = LOG_DIR, level: str = LOG_LEVEL, theme: str = LOG_THEME)` - Инициализация логгера
- `info(message: str, class_name: Optional[str] = None, func_name: Optional[str] = None) -> None` - Логирование уровня INFO
- `debug(message: str, class_name: Optional[str] = None, func_name: Optional[str] = None) -> None` - Логирование уровня DEBUG
- `warning(message: str, class_name: Optional[str] = None, func_name: Optional[str] = None) -> None` - Логирование уровня WARNING
- `error(message: str, class_name: Optional[str] = None, func_name: Optional[str] = None) -> None` - Логирование уровня ERROR

### Класс DebugTabNumberTracker
Класс для сбора детальной статистики по табельным номерам из DEBUG_TAB_NUMBER.

**Методы:**
- `__init__(logger_instance: Optional[Logger] = None)` - Инициализация трекера
- `add_source_file_data(tab_number: str, file_name: str, group: str, month: int, clients_data: List[Dict[str, Any]], tb_variants: Dict[str, float], selected_tb: str, selected_sum: float) -> None` - Добавляет данные из исходного файла
- `add_raw_data(tab_number: str, raw_data: Dict[str, Dict[str, Any]]) -> None` - Добавляет данные после схлопывания (RAW)
- `add_calculations(tab_number: str, calculations: Dict[str, Dict[str, float]]) -> None` - Добавляет результаты расчетов
- `add_normalization(tab_number: str, normalization: Dict[str, Dict[str, float]]) -> None` - Добавляет нормализованные значения
- `add_scores(tab_number: str, scores: Dict[str, float], best_month: str) -> None` - Добавляет Score и лучший месяц
- `set_unique_inn_count(tab_number: str, count: int) -> None` - Устанавливает количество уникальных ИНН
- `get_tab_data(tab_number: str) -> Optional[Dict[str, Any]]` - Получает собранные данные для табельного номера
- `get_all_tab_numbers() -> List[str]` - Возвращает список всех отслеживаемых табельных номеров

### Класс FileProcessor
Класс для обработки Excel файлов.

**Атрибуты:**
- `debug_tracker: DebugTabNumberTracker` - Трекер для сбора детальной статистики по табельным номерам из DEBUG_TAB_NUMBER

**Методы:**
- `__init__(input_dir: str = INPUT_DIR, logger_instance: Optional[Logger] = None)` - Инициализация процессора
- `load_all_files() -> None` - Загружает все файлы из подкаталогов, собирает статистику по каждому файлу (DEBUG) и выводит сводную статистику (INFO)
- `collect_unique_tab_numbers() -> None` - Собирает уникальные табельные номера (оптимизировано: использует `itertuples()` вместо `iterrows()`). Также собирает данные для debug_tracker
- `prepare_raw_data() -> pd.DataFrame` - Подготавливает сырые данные для листа "RAW" (параллельная обработка всех файлов). Также собирает данные для debug_tracker. Если `ENABLE_RAW_SHEETS=False`, сразу возвращает пустой DataFrame без обработки
- `prepare_summary_data() -> pd.DataFrame` - Подготавливает сводные данные для листа "Исходник" (оптимизировано: параллельное создание индексов и `groupby()` вместо фильтрации в циклах)
- `prepare_calculated_data(summary_df: pd.DataFrame) -> pd.DataFrame` - Подготавливает расчетные данные для листа "Расчет"
- `_normalize_indicators(calculated_df: pd.DataFrame, config_manager) -> pd.DataFrame` - Нормализует показатели для расчета лучшего месяца (вариант 3, параллельная нормализация всех групп)
- `_calculate_best_month_variant3(calculated_df: pd.DataFrame, normalized_df: pd.DataFrame, config_manager, raw_df: Optional[pd.DataFrame] = None) -> Tuple[pd.DataFrame, pd.DataFrame]` - Рассчитывает Score (параллельно для всех месяцев), ранги и определяет лучший месяц для каждого КМ. Также собирает данные для debug_tracker
- `prepare_statistics_sheet() -> Optional[pd.DataFrame]` - Формирует лист со статистикой обработки данных (если ENABLE_STATISTICS = True)
- `_log_statistics() -> None` - Выводит статистику в лог

**Пример использования:**
```python
processor = FileProcessor(input_dir="IN", logger_instance=logger)
processor.load_all_files()
processor.collect_unique_tab_numbers()
summary_df = processor.prepare_summary_data()
calculated_df = processor.prepare_calculated_data(summary_df)
```

### Класс ExcelFormatter
Класс для форматирования Excel файлов.

**Методы:**
- `__init__(logger_instance: Optional[Logger] = None)` - Инициализация форматтера
- `format_excel_file(file_path: str, sheet_name: str = "Sheet1") -> None` - Форматирует существующий Excel файл
- `create_formatted_excel(raw_df: pd.DataFrame, summary_df: pd.DataFrame, calculated_df: pd.DataFrame, normalized_df: pd.DataFrame, places_df: pd.DataFrame, final_df: pd.DataFrame, output_path: str, statistics_df: Optional[pd.DataFrame] = None, debug_tracker: Optional[DebugTabNumberTracker] = None) -> None` - Создает новый Excel файл с основными листами (RAW опционально, Исходник, Расчет, Нормализация, Места и выбор, Итог) + лист "Статистика" (если включен) + детальные листы (если DEBUG_TAB_NUMBER указан) и форматированием
- `_create_debug_tab_sheets(debug_tracker: DebugTabNumberTracker, writer: pd.ExcelWriter) -> None` - Создает детальные листы Excel для табельных номеров из DEBUG_TAB_NUMBER
- `_format_sheet_minimal(ws, df: pd.DataFrame, sheet_name: str) -> None` - Минимальное форматирование листа (только ТН и ИНН, используется при FORMATTING_MODE="off")
- `_format_debug_tab_sheet(ws, sheet_name: str) -> None` - Форматирует детальный лист для табельного номера

**Пример использования:**
```python
formatter = ExcelFormatter(logger_instance=logger)
formatter.create_formatted_excel(summary_df, calculated_df, "output.xlsx")
```

### Функция main()
Основная функция приложения. Координирует все этапы обработки данных.

## Структура проекта

```
YEAR_SPOD_TOP_Month/
├── main.py                       # Основной файл приложения (все в одном файле)
├── README.md                     # Документация проекта
├── requirements.txt              # Зависимости проекта
├── .gitignore                   # Игнорируемые файлы для Git
├── log/                          # Каталог для логов
├── Docs/                         # Дополнительная документация
├── IN/                           # Входные данные
│   ├── OD/                       # Подкаталог OD (11-12 файлов)
│   ├── RA/                       # Подкаталог RA (11-12 файлов)
│   └── PS/                       # Подкаталог PS (11-12 файлов)
└── OUT/                          # Выходные файлы
```

**Особенности структуры:**
- Все код (конфигурация, логика, форматирование) находится в одном файле `main.py`
- Настройки задаются в начале файла `main.py` как константы
- Документация хранится в папке `Docs`

## Использование

### Установка зависимостей

**Важно:** Программа использует только базовые модули Anaconda. Дополнительная установка пакетов не требуется.

Если у вас установлена Anaconda, то:
- `pandas` обычно уже установлен
- `openpyxl` обычно уже установлен (для форматирования, приоритетный вариант)
- `xlsxwriter` может быть установлен (для форматирования, резервный вариант), но не обязателен

Программа автоматически определяет доступные модули и использует их в порядке приоритета:
1. **openpyxl** (если доступен) - полное форматирование
2. **xlsxwriter** (если доступен) - полное форматирование
3. **Без форматирования** - файл создается, но без форматирования

В любом случае вся функциональность сохраняется.

### Настройка

Откройте файл `main.py` и измените настройки в начале файла:

```python
# Пути к каталогам
INPUT_DIR = "IN"      # Каталог с входными данными
OUTPUT_DIR = "OUT"    # Каталог для выходных файлов
LOG_DIR = "log"       # Каталог для логов

# Уровень логирования
LOG_LEVEL = "DEBUG"    # DEBUG (в файлы) - детальное, INFO (в консоль) - верхнеуровневое
```

### Запуск

```bash
python main.py
```

### Настройка конфигурации загрузки файлов

По умолчанию для каждой группы (OD, RA, PS) заданы следующие настройки в блоке `defaults=DefaultsConfig(...)`:

**Колонки по умолчанию:**
- Табельный номер (alias: `tab_number`)
- Короткое ТБ (alias: `tb`)
- Полное ГОСБ (alias: `gosb`) - оставлено для обратной совместимости, не выводится в файлы
- ИНН (alias: `client_id`)
- ФИО (alias: `fio`)
- Факт (alias: `indicator`)

**Параметры расчета для листа "Расчет":**
- `calculation_type`: Тип расчета (1 - как есть, 2 - прирост по 2 месяцам, 3 - прирост по трем периодам)
- `first_month_value`: Значение для первого месяца при расчете типа 2 ("self" - равен самому себе, "zero" - равен 0)
- `three_periods_first_months`: Правила для первого и второго месяца при расчете типа 3 ("zero_both", "zero_first_diff_second", "self_first_diff_second")

**Параметры нормализации и расчета Score (вариант 3):**
- `indicator_direction`: Направление показателя для нормализации ("MAX" - большее значение лучше, "MIN" - меньшее значение лучше)
- `weight`: Вес для данной группы при расчете Score (в каждом разделе задается только свой вес)
  - В разделе OD: `weight=0.33` (вес для группы OD)
  - В разделе RA: `weight=0.33` (вес для группы RA)
  - В разделе PS: `weight=0.34` (вес для группы PS)
- Score рассчитывается по формуле: `Score (M-X) = OD_norm (M-X) × weight_od + RA_norm (M-X) × weight_ra + PS_norm (M-X) × weight_ps`
- Сумма весов всех групп должна быть равна 1.0 (или близка к 1.0)
- Для каждого месяца (M-1 до M-12) создается колонка Score
- Для каждого КМ рассчитывается горизонтальный ранг по Score (месяц с наибольшим Score получает ранг 1)
- Для каждого КМ определяется лучший месяц (месяц с рангом 1 по Score)
- Если несколько месяцев имеют одинаковый Score (ранг 1), применяется дополнительная логика выбора

**Индивидуальные настройки для файлов:**

Параметры расчета можно задавать для каждого файла индивидуально в `FileItem`. Если параметры не указаны (None), используются значения из `defaults`.

Примеры:
```python
# Использовать default значения
FileItem(key="OD_01", ..., calculation_type=None, first_month_value=None, three_periods_first_months=None)

# Задать индивидуальные значения для конкретного файла
FileItem(key="OD_01", ..., calculation_type=2, first_month_value="zero")  # Тип 2, первый месяц = 0
FileItem(key="OD_02", ..., calculation_type=3, three_periods_first_months="self_first_diff_second")  # Тип 3 с особыми правилами
```

Для изменения настроек по умолчанию отредактируйте блок `defaults=DefaultsConfig(...)` в функции `_create_default_configs()` в файле `main.py`.

## История версий

### Версия 1.12.0
**Дата:** 2025-12-15

**Добавлены триггеры для RAW листов и форматирования:**
- ✅ Добавлен параметр `ENABLE_RAW_SHEETS` (bool, по умолчанию False): триггер для включения/выключения формирования RAW листов
  * Если False - RAW листы не создаются и не выводятся в файл
  * Если False - подготовка RAW данных полностью пропускается для экономии времени
  * ВАЖНО: При ENABLE_RAW_SHEETS=False колонка "Количество уникальных ИНН" в листе "Итог" будет заполнена нулями
- ✅ Добавлен параметр `FORMATTING_MODE` (str, по умолчанию "full"): триггер для режима форматирования листов
  * "full" - полное форматирование (как сейчас, по умолчанию)
  * "off" - форматирование выключено (листы формируются, но не переформатируются, кроме ТН и ИНН - их форматы всегда работают)
  * "simple" - упрощенное форматирование (только ТН, ИНН, ФИО, ТБ, ГОСБ и заголовок, не форматируем данные показателей и расчетов)
- ✅ Создан метод `_format_sheet_minimal` для минимального форматирования (только ТН и ИНН)
- ✅ Обновлена логика форматирования в `_format_sheet_openpyxl` для поддержки всех трех режимов
- ✅ ТН и ИНН всегда форматируются независимо от режима
- ✅ Добавлено логирование режимов форматирования и состояния RAW листов

**Результат:**
- Возможность отключения RAW листов для ускорения работы и уменьшения размера файла
- Гибкая настройка уровня форматирования в зависимости от потребностей
- Ускорение обработки при упрощенном форматировании или отключенном форматировании

### Версия 1.11.0
**Дата:** 2025-12-15

**Добавлены детальные листы Excel для табельных номеров из DEBUG_TAB_NUMBER:**
- ✅ Создан класс `DebugTabNumberTracker` для сбора детальной статистики по табельным номерам
- ✅ Сбор данных на всех этапах обработки:
  * В исходных файлах: клиенты (ИНН) с ТБ, варианты ТБ, выбранный вариант
  * После схлопывания (RAW): данные по ИНН с суммами по файлам
  * Результаты расчетов: факт, прирост по 2м, прирост по 3м
  * Нормализация: нормализованные значения OD, RA, PS
  * Score и лучший месяц: Score по месяцам, выбранный месяц
  * Количество уникальных ИНН
- ✅ Создан метод `_create_debug_tab_sheets` для формирования детальных листов Excel
- ✅ Каждый лист содержит несколько таблиц:
  * Исходные файлы: какие клиенты с какими ТБ были в каждом файле
  * Данные после схлопывания (RAW): итоговые суммы по файлам
  * Результаты расчетов: факт, прирост по 2м, прирост по 3м
  * Нормализация: нормализованные значения по месяцам
  * Score и выбор месяца: Score по месяцам, лучший месяц
  * Итоговая статистика: сводная информация
- ✅ Добавлено форматирование детальных листов с выделением заголовков таблиц
- ✅ Детальные листы автоматически добавляются в итоговый Excel файл
- ✅ Исправлена нормализация табельных номеров в трекере для корректного совпадения ключей

**Результат:**
- Для каждого табельного номера из `DEBUG_TAB_NUMBER` создается отдельный лист с детальной информацией о всех этапах обработки
- Полная прозрачность обработки данных для выбранных табельных номеров
- Удобный анализ причин выбора определенных значений и месяцев

### Версия 1.10.0
**Дата:** 2025-12-11

**Убрана колонка ГОСБ из всех листов:**
- ✅ Убрана ГОСБ из всех выходных листов (RAW, Исходник, Расчет, Нормализация, Места и выбор, Итог)
- ✅ Изменена группировка в RAW: теперь по ТН+ТБ+ФИО+ИНН (без ГОСБ)
- ✅ Изменена логика выбора ТБ: если у табельного несколько вариантов ТБ, выбирается вариант с максимальной суммой показателя
- ✅ Улучшено логирование выбора ТБ: добавлена детальная информация о всех вариантах с суммами и выбранном варианте
- ✅ ГОСБ оставлена только в параметрах конфигурации (gosb_column) для обратной совместимости
- ✅ Обновлена статистика: убраны упоминания ГОСБ

**Результат:**
- Все листы теперь содержат только базовые колонки: Табельный, ТБ, ФИО
- Улучшена прозрачность выбора ТБ: в логах видно все варианты и причины выбора
- Параметр gosb_column сохранен в конфигурации для обратной совместимости

### Версия 1.9.0
**Дата:** 2025-12-11

**Реализована параллельная обработка для оптимизации производительности:**
- ✅ Увеличен MAX_WORKERS с 4 до 8 для лучшего использования ресурсов
- ✅ Параллельная загрузка всех групп (OD, RA, PS одновременно) - ускорение 2-3x
- ✅ Параллельное создание индексов в prepare_summary_data() - ускорение 3-4x
- ✅ Параллельная обработка файлов в prepare_raw_data() - ускорение 3-4x
- ✅ Параллельная нормализация по группам в _normalize_indicators() - ускорение 2-3x
- ✅ Параллельный расчет Score по месяцам в _calculate_best_month_variant3() - ускорение 2-3x
- ✅ Исправлены предупреждения в логах: изменен уровень логирования с WARNING на DEBUG для отсутствующих колонок

**Результат:**
- Общее ускорение: 3-4x (с ~46 сек до ~10-15 сек)
- Все операции, которые могут выполняться параллельно, теперь выполняются параллельно
- Улучшено использование ресурсов системы (8 потоков вместо 4)

### Версия 1.8.1
**Дата:** 2025-12-11

**Критическое исправление потери данных ТБ, ФИО:**
- ✅ Исправлена критическая ошибка, из-за которой колонки ТБ, ФИО терялись на всех листах (Исходник, Расчет, Нормализация, Места и выбор, Итог)
- ✅ Проблема была в методе `prepare_calculated_data`: конвертация в числовой тип применялась ко всем колонкам типа `object`, включая текстовые колонки ТБ, ФИО
- ✅ Исправление: базовые текстовые колонки (`Табельный`, `ТБ`, `ФИО`, `ИНН`) теперь исключены из конвертации в числовой тип
- ✅ Конвертация числовых колонок теперь выполняется только после копирования DataFrame, чтобы не испортить исходные данные
- ✅ Добавлено расширенное логирование для диагностики потери данных на всех этапах обработки
- ✅ Оптимизация `collect_unique_tab_numbers`: заменен `iterrows()` на `itertuples()` для ускорения (12x быстрее)

**Результат:**
- Колонки ТБ, ФИО теперь корректно сохраняются на всех листах Excel файла
- Данные не теряются при обработке и расчетах
- Улучшена производительность сбора уникальных табельных номеров

### Версия 1.8.0
**Дата:** 2025-12-09

**Добавлен лист "Статистика" с подробной аналитикой:**
- ✅ Добавлен параметр `ENABLE_STATISTICS` для включения/выключения сбора статистики
- ✅ Реализован сбор статистики по файлам: исходное количество строк, удалено по drop_rules, оставлено по in_rules, итоговое количество
- ✅ Реализован сбор статистики выбора табельных номеров: сколько было вариантов ТБ, сколько выбрано, сколько табельных с несколькими вариантами, детальная информация о вариантах с суммами
- ✅ Реализован сбор итоговой статистики: количество КМ, уникальных клиентов, распределение по ТБ
- ✅ Создан лист "Статистика" в Excel с несколькими таблицами:
  - Общая статистика (КМ, клиенты)
  - Количество КМ по ТБ
  - Количество КМ по ТБ (распределение по территориальным банкам)
  - Статистика обработки файлов (исходно, удалено, оставлено, итого)
  - Детальная статистика по drop_rules
  - Детальная статистика по in_rules
  - Статистика выбора табельных номеров
- ✅ Реализовано форматирование листа "Статистика": заголовки разделов, таблицы, числа
- ✅ Реализован вывод статистики в лог (метод `_log_statistics()`)
- ✅ Статистика собирается только если `ENABLE_STATISTICS = True`, что позволяет отключать сбор для ускорения работы

**Реализован вариант 3 расчета лучшего месяца:**
- ✅ Реализована нормализация показателей горизонтально по месяцам для каждого КМ
- ✅ Учет направления показателя (MAX/MIN) при нормализации
- ✅ Расчет взвешенного Score для каждого месяца
- ✅ Определение горизонтального ранга по Score
- ✅ Созданы дополнительные листы: "Нормализация", "Места и выбор", "Итог"
- ✅ Исправлена нормализация для случая одного месяца с данными (месяц с данными получает 1.0, остальные 0.0)

**Результат:**
- Подробная аналитика обработки данных доступна в листе "Статистика"
- Статистика выводится в лог для анализа
- Возможность отключения статистики для ускорения работы
- Наглядное представление всех этапов расчета лучшего месяца

### Версия 1.7.0
**Дата:** 2025-12-09

**Добавлена статистика загрузки данных:**
- ✅ Пофайловая статистика (DEBUG): для каждого загруженного файла выводится количество строк, уникальных клиентов (ИНН), уникальных табельных номеров
- ✅ Сводная статистика (INFO): после загрузки всех файлов выводится общий объем данных в строках, уникальных клиентах и табельных номерах
- ✅ Статистика собирается без замедления работы (используются уже загруженные DataFrame)
- ✅ Операции `len()` и `nunique()` выполняются быстро на уже загруженных данных

**Примеры вывода:**
- DEBUG (пофайлово): `Загружен файл M-1_OD.xlsx (OD M-1): 1234 строк, 567 уникальных клиентов (ИНН), 890 уникальных табельных номеров`
- INFO (сводная): `Загрузка завершена. Обработано групп: 3. Итого: 45678 строк, 1234 уникальных клиентов (ИНН), 2345 уникальных табельных номеров`

**Результат:**
- Быстрая оценка объема загруженных данных
- Детальная информация по каждому файлу доступна в логах (DEBUG)
- Верхнеуровневая сводная информация выводится в консоль (INFO)

### Версия 1.6.0
**Дата:** 2025-12-09

**Реорганизация логирования:**
- ✅ Разделение уровней логирования на INFO и DEBUG
- ✅ Консольный обработчик настроен на INFO (DEBUG не выводится в консоль)
- ✅ Файловый обработчик настроен на DEBUG (все логи записываются в файлы)
- ✅ Перенос детальных логов из INFO в DEBUG для следующих методов:
  - `prepare_summary_data`: информация о группах, создание индексов, прогресс обработки → DEBUG
  - `prepare_calculated_data`: обработка группы, информация о месяцах → DEBUG
  - `_calculate_ranks`: параметры расчета, информация о группах, детали проверок → DEBUG
  - `_calculate_final_ranks`: веса, информация о месяцах, диапазоны значений → DEBUG
- ✅ INFO теперь содержит только верхнеуровневую информацию:
  - Начало/конец этапов
  - Итоговые результаты (сколько обработано, создано)
  - Важные события

**Результат:**
- В консоль выводится только верхнеуровневая информация (INFO, ERROR, WARNING)
- В файлы записывается вся информация (INFO + DEBUG)
- INFO больше не перегружен деталями

### Версия 1.5.0
**Дата:** 2025-12-09

**Критические оптимизации производительности:**
- ✅ Оптимизация `collect_unique_tab_numbers()`: заменен `iterrows()` на `itertuples()` (ускорение 12x)
- ✅ Оптимизация `prepare_summary_data()`: предварительная индексация по табельным номерам вместо фильтрации в циклах (ускорение >277x)
- ✅ Нормализация табельных номеров выполняется один раз для каждого файла
- ✅ Кэширование конфигураций групп (ускорение 1.5-3x)
- ✅ Кэширование номеров месяцев из имен файлов (ускорение 1.2-2x)
- ✅ Использование `groupby()` для агрегации данных вместо фильтрации в циклах

**Результаты оптимизации (по логам):**
- Общее ускорение программы: **16.9x**
- Время выполнения: **12.9 минут → 46 секунд**
- Экономия времени: **12.2 минуты на каждый запуск**
- Подготовка сводных данных: **>277x** (с 4.6 минут до <1 секунды)
- Сбор уникальных табельных номеров: **12x** (с 12 секунд до 1 секунды)

**Исправление структуры весов:**
- ✅ Изменена структура `DefaultsConfig`: один параметр `weight` вместо `weight_od`, `weight_ra`, `weight_ps`
- ✅ В каждом разделе (OD, RA, PS) задается только свой вес
- ✅ Обновлен метод `_calculate_final_ranks` для получения весов из соответствующих разделов

**Технические детали:**
- Предварительная индексация создает словари `{tab_number: sum}` для каждого файла один раз
- Использование `groupby()` для агрегации данных вместо фильтрации DataFrame в вложенных циклах
- Замена `iterrows()` на `itertuples()` значительно ускоряет итерацию по строкам DataFrame
- Кэширование результатов извлечения номеров месяцев из имен файлов

### Версия 1.4.0
**Дата:** 2025-12-09

**Примечание:** Эта версия больше не актуальна. Функционал расчета рангов и R_FIN был заменен на вариант 3 с нормализацией и Score в версии 1.8.0.

### Версия 1.3.0
**Дата:** 2025-12-08

**Примечание:** Эта версия больше не актуальна. Функционал расчета рангов для колонок на листе "Расчет" был удален. Вместо этого используется вариант 3 с нормализацией и Score (версия 1.8.0).

### Версия 1.2.0
**Дата:** 2025-01-XX

**Новые возможности:**
- ✅ Добавлен второй лист "Расчеты" в выходной Excel файл
- ✅ Реализованы три типа расчетов для второго листа:
  * Тип 1: "Как есть" - просто сумма данных (аналог первого листа)
  * Тип 2: "Прирост по 2 месяцам" - текущий месяц минус предыдущий месяц
  * Тип 3: "Прирост по трем периодам" - М-N = М-N - 2*М-(N-1) + М-(N-2)
- ✅ Добавлена возможность задавать параметры расчета для каждого файла индивидуально в `FileItem`
- ✅ Реализована структура `DefaultsConfig` для консолидации всех настроек по умолчанию в одном блоке
- ✅ Добавлена фиксация первой строки и первых 4 колонок (до ФИО включительно) на обоих листах
- ✅ Обновлена структура конфигурации: все default настройки собраны в блок `defaults=DefaultsConfig(...)`

**Технические детали:**
- Параметры расчета (`calculation_type`, `first_month_value`, `three_periods_first_months`) можно задавать как в `defaults`, так и для каждого `FileItem` индивидуально
- Если параметры не указаны в `FileItem` (None), используются значения из `defaults`
- Правила для первых месяцев при расчете типа 3: "zero_both", "zero_first_diff_second", "self_first_diff_second"
- Значение для первого месяца при расчете типа 2: "self" (равен самому себе) или "zero" (равен 0)

### Версия 1.1.0
**Дата:** 2025-01-XX

**Новые возможности:**
- ✅ Обновлены имена файлов на формат `M-{номер}_{группа}.xlsx` (M-1_OD.xlsx, M-2_RA.xlsx и т.д.)
- ✅ Обновлены имена колонок в конфигурации:
  * Табельный → Табельный номер
  * ТБ → Короткое ТБ
  * ГОСБ → Полное ГОСБ
  * КМ → ИНН (client_id)
  * Показатель → Факт
- ✅ Унифицированы имена колонок во всех трех группах (OD, RA, PS)
- ✅ Добавлено упорядочивание колонок по месяцам (M-1, M-2, ..., M-12) для каждой группы
- ✅ Добавлено числовое форматирование: разделитель разрядов и два знака после запятой
- ✅ Добавлено форматирование табельного номера: 8 знаков с лидирующими нулями
- ✅ Обновлена функция `extract_month_number` для поддержки нового формата имен файлов

**Технические детали:**
- Порядок колонок в итоговом файле: базовые (Табельный, ТБ, ФИО), затем OD M-1...M-12, RA M-1...M-12, PS M-1...M-12
- Табельный номер форматируется как текст с лидирующими нулями (формат `@` в Excel)
- Числовые колонки используют формат `#,##0.00` (разделитель разрядов и два знака после запятой)

### Версия 1.0.0
**Дата создания:** 2025-01-XX

**Реализованный функционал:**
- ✅ Создана базовая структура проекта
- ✅ Все компоненты объединены в один файл `main.py`
- ✅ Реализован модуль конфигурации с поддержкой групповых и пофайловых настроек
- ✅ Реализована система логирования с уровнями INFO и DEBUG
- ✅ Реализован модуль загрузки и обработки Excel файлов
- ✅ Реализован сбор уникальных табельных номеров с учетом приоритета данных
- ✅ Реализовано формирование сводных данных с суммированием показателей
- ✅ Реализован модуль форматирования Excel файлов
- ✅ Реализована основная функция приложения

**Технические детали:**
- Проект использует Python 3.8+
- Используются только базовые модули Anaconda: pandas (обязательно), openpyxl (обычно доступен), xlsxwriter (опционально)
- Приоритет форматирования: openpyxl > xlsxwriter > без форматирования
- Все логи сохраняются в каталог `log` с именованием по шаблону
- Конфигурация поддерживает настройки по умолчанию для групп и пофайловые настройки
- Приоритет данных: OD > RA > PS, 12 месяц > 11 месяц > ... > 1 месяц
- Все настройки находятся в начале файла `main.py` как константы
- Если ни openpyxl, ни xlsxwriter недоступны, файл создается без форматирования, но функциональность сохраняется

**Решенные проблемы:**
- Реализована гибкая система конфигурации для различных типов файлов
- Обеспечена корректная обработка отсутствующих колонок
- Реализована проверка обязательных полей
- Оптимизирована обработка больших объемов данных
- Упрощена структура проекта - все в одном файле

## Технические требования

- Python 3.8 или выше
- Anaconda (базовая установка)
- pandas (обычно входит в Anaconda)
- openpyxl (обычно входит в Anaconda - для форматирования, приоритетный вариант)
- xlsxwriter (опционально, если доступен в Anaconda - для форматирования, резервный вариант)
- Excel файлы в формате .xlsx или .xls

**Важно:** Программа разработана для работы только с базовыми модулями Anaconda. Установка дополнительных пакетов через pip не требуется и может быть запрещена политикой безопасности. Программа автоматически определяет доступные модули и использует их в порядке приоритета: openpyxl > xlsxwriter > без форматирования.

## Примечания

- Все файлы должны содержать колонки: Табельный номер, Короткое ТБ, ИНН, ФИО, Факт
- Примечание: колонка "Полное ГОСБ" может присутствовать в исходных файлах, но не выводится в итоговые листы
- Имена файлов должны быть в формате `M-{номер}_{группа}.xlsx`, где номер месяца от 1 (январь) до 12 (декабрь)
- Номер месяца определяется автоматически из имени файла (формат `M-{номер}_`)
- Поддерживается альтернативная нумерация T-11 (январь) до T-0 (декабрь)
- Табельный номер автоматически форматируется как 8 знаков с лидирующими нулями
- При отсутствии данных в файле для табельного номера, сумма показателя устанавливается в 0
- Итоговый файл содержит основные листы: "RAW" (если `ENABLE_RAW_SHEETS = True`), "Исходник", "Расчет", "Нормализация", "Места и выбор", "Итог" + лист "Статистика" (если `ENABLE_STATISTICS = True`) + детальные листы (если `DEBUG_TAB_NUMBER` указан)
- Итоговый файл сохраняется с временной меткой в имени для предотвращения перезаписи
- Все настройки находятся в начале файла `main.py` - измените их при необходимости
- **Детальное логирование:** Если указан `DEBUG_TAB_NUMBER` (список табельных номеров), для каждого табельного номера создается отдельный лист Excel с подробной статистикой о всех этапах обработки. Также в лог записывается подробная информация о всех операциях с этими табельными номерами
- **Режимы форматирования:** Параметр `FORMATTING_MODE` позволяет выбрать уровень форматирования:
  - "full" - полное форматирование всех колонок (по умолчанию)
  - "off" - форматирование выключено (кроме ТН и ИНН, которые всегда форматируются)
  - "simple" - упрощенное форматирование (только базовые колонки: ТН, ИНН, ФИО, ТБ, ГОСБ)
- **RAW листы:** Параметр `ENABLE_RAW_SHEETS` позволяет отключить создание RAW листов для ускорения работы и уменьшения размера файла. При `ENABLE_RAW_SHEETS=False` подготовка RAW данных полностью пропускается для экономии времени. ВАЖНО: При отключенных RAW листах колонка "Количество уникальных ИНН" в листе "Итог" будет заполнена нулями
- Числовые значения в итоговом файле отображаются с разделителем разрядов и двумя знаками после запятой
- Колонки Score и нормализованных значений отображаются как числа с разделителем разрядов и двумя знаками после запятой (например, `0,85`)
- Колонки ранга (места) на листе "Места и выбор" отображаются как целые числа с разделителем разрядов без дробной части (например, `1`)
- Колонка "Лучший месяц" отображается в текстовом формате (например, "3" или "3, 5")
- Параметры расчета можно задавать как в `defaults` (для всей группы), так и для каждого `FileItem` индивидуально
- Веса для расчета Score задаются в блоке `defaults=DefaultsConfig(...)` для каждой группы отдельно (в разделе OD задается weight для OD, в разделе RA - для RA, в разделе PS - для PS)
- Score рассчитывается как взвешенная сумма нормализованных значений групп OD, RA и PS для каждого месяца
- Лучший месяц определяется как месяц с рангом 1 по Score для каждого КМ (горизонтальный ранг)
- Первая строка и первые 4 колонки (до ФИО включительно) зафиксированы на основных листах для удобства просмотра
- **Логирование:** Программа использует два уровня логирования:
  - **INFO** (верхнеуровневое): выводится в консоль и записывается в файлы - начало/конец этапов, итоговые результаты
  - **DEBUG** (детальное): записывается только в файлы - детальная информация о процессе обработки, параметры расчетов, прогресс обработки
- В консоль выводится только верхнеуровневая информация (INFO, ERROR, WARNING), детальная информация (DEBUG) доступна только в файлах логов
- **Статистика загрузки данных:** При загрузке файлов собирается статистика:
  - Пофайловая статистика (DEBUG): для каждого файла выводится количество строк, уникальных клиентов (ИНН), уникальных табельных номеров
  - Сводная статистика (INFO): общий объем данных в строках, уникальных клиентах и табельных номерах по всем загруженным файлам
  - Статистика собирается без замедления работы (используются уже загруженные DataFrame)
- **Статистика обработки данных:** Если `ENABLE_STATISTICS = True`, собирается подробная статистика:
  - Статистика по файлам: исходное количество строк, удалено по drop_rules, оставлено по in_rules, итоговое количество
  - Статистика выбора табельных номеров: сколько было вариантов ТБ, сколько выбрано, детальная информация о вариантах с суммами
  - Итоговая статистика: количество КМ, клиентов, распределение по ТБ
  - Статистика выводится в лист "Статистика" в Excel и в лог
- **Производительность:** Благодаря оптимизациям (предварительная индексация, использование groupby(), замена iterrows() на itertuples()) программа работает в 16.9 раз быстрее, чем до оптимизаций. Обработка 1604 табельных номеров и 36 файлов занимает менее 1 секунды вместо 4.6 минут
