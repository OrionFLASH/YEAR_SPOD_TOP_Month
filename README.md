# Обработка месячных данных (YEAR_SPOD_TOP_Month)

## Формулировка задачи и техническое задание

### Задача
Создать систему для автоматической обработки месячных данных из Excel файлов, расположенных в подкаталогах `OD`, `RA` и `PS` внутри каталога `IN`. Система должна:

1. Загружать файлы из всех подкаталогов с учетом настроек для каждой группы
2. Собирать уникальные табельные номера из всех файлов
3. Определять приоритетные данные для каждого табельного номера (ОД > RA > PS, 12 месяц > 11 месяц > ...)
4. Формировать сводный Excel файл с суммированием показателей по каждому файлу
5. Применять форматирование к итоговому файлу согласно требованиям

### Техническое задание

**Входные данные:**
- Каталог `IN` с подкаталогами: `OD`, `RA`, `PS`
- В каждом подкаталоге от 11 до 12 Excel файлов с месячными данными
- Каждый файл содержит колонки: Табельный, ТБ, ГОСБ, КМ, ФИО, Показатель

**Выходные данные:**
- Excel файл со сводными данными:
  - Уникальные табельные номера
  - ТБ, ГОСБ, ФИО (из файла с наивысшим приоритетом)
  - Колонки с суммами показателей из каждого файла

**Требования к форматированию:**
- Первая строка зафиксирована
- Заголовки жирным шрифтом, размер минимум 15
- Ширина колонок: минимум 15, максимум 150
- Подбор ширины по содержимому
- Перенос текста по словам
- Автофильтр включен

## Подробное описание решения

### Архитектура системы

Все компоненты системы находятся в одном файле `main.py`:

1. **Настройки приложения** - пути к каталогам и уровень логирования
2. **Конфигурация загрузки файлов** - настройки по умолчанию для групп OD, RA, PS и пофайловые настройки
3. **Модуль логирования** - система логирования с уровнями INFO и DEBUG
4. **Модуль обработки файлов** - загрузка и обработка Excel файлов
5. **Модуль форматирования Excel** - форматирование итоговых Excel файлов
6. **Основная функция** - координация всех этапов обработки

### Алгоритм работы

1. **Загрузка файлов:**
   - Сканирование подкаталогов OD, RA, PS
   - Загрузка каждого Excel файла с применением конфигурации группы
   - Фильтрация колонок согласно настройкам
   - Проверка обязательных полей

2. **Сбор уникальных табельных номеров:**
   - Извлечение всех табельных номеров из всех файлов
   - Определение приоритета данных:
     - По группам: OD (приоритет 1) > RA (приоритет 2) > PS (приоритет 3)
     - По месяцам: 12 > 11 > ... > 1
   - Сохранение ТБ, ГОСБ, ФИО из файла с наивысшим приоритетом

3. **Формирование сводных данных:**
   - Для каждого уникального табельного номера
   - Сбор сумм показателей из каждого файла
   - Создание структуры: строки = табельные номера, колонки = файлы

4. **Сохранение и форматирование:**
   - Сохранение данных в Excel
   - Применение форматирования к заголовкам и ячейкам
   - Настройка ширины колонок и автофильтра

## Полный список переменных и функций

### Настройки приложения

Все настройки находятся в начале файла `main.py`:

```python
INPUT_DIR = "IN"      # Каталог с входными данными
OUTPUT_DIR = "OUT"     # Каталог для выходных файлов
LOG_DIR = "log"        # Каталог для логов
LOG_LEVEL = "INFO"     # Уровень логирования (INFO или DEBUG)
LOG_THEME = "processor"  # Тема логов
```

### Класс FileConfig
Конфигурация для отдельного файла.

**Поля:**
- `columns: Optional[List[str]]` - Колонки для загрузки (None = использовать настройки группы)
- `exclude_fields: List[str]` - Поля для исключения
- `required_fields: List[str]` - Обязательные поля
- `custom_settings: Dict[str, Any]` - Дополнительные настройки

**Пример использования:**
```python
file_config = FileConfig(
    columns=["Табельный", "ТБ", "ГОСБ", "ФИО", "Показатель"],
    exclude_fields=["Примечание"],
    required_fields=["Табельный", "ФИО"]
)
```

### Класс GroupConfig
Конфигурация для группы файлов (OD, RA, PS).

**Поля:**
- `name: str` - Название группы
- `default_columns: List[str]` - Колонки по умолчанию
- `default_exclude_fields: List[str]` - Поля для исключения по умолчанию
- `default_required_fields: List[str]` - Обязательные поля по умолчанию
- `file_configs: Dict[str, FileConfig]` - Пофайловые настройки
- `tab_number_column: str` - Название колонки с табельным номером
- `tb_column: str` - Название колонки с ТБ
- `gosb_column: str` - Название колонки с ГОСБ
- `fio_column: str` - Название колонки с ФИО
- `indicator_column: str` - Название колонки с показателем

### Класс ConfigManager
Менеджер конфигурации для управления настройками загрузки файлов.

**Методы:**
- `get_config_for_file(group_name: str, file_name: str) -> Dict[str, Any]` - Получает конфигурацию для конкретного файла
- `add_file_config(group_name: str, file_pattern: str, file_config: FileConfig) -> None` - Добавляет пофайловую конфигурацию
- `get_group_config(group_name: str) -> GroupConfig` - Получает конфигурацию группы

**Пример использования:**
```python
# Получить конфигурацию для файла
config = config_manager.get_config_for_file("OD", "file_12.xlsx")

# Добавить пофайловую конфигурацию
custom_config = FileConfig(
    columns=["Табельный", "ТБ", "ФИО"],
    exclude_fields=["КМ"]
)
config_manager.add_file_config("OD", "special_file.xlsx", custom_config)
```

### Класс Logger
Класс для настройки и управления логированием.

**Методы:**
- `__init__(log_dir: str = LOG_DIR, level: str = LOG_LEVEL, theme: str = LOG_THEME)` - Инициализация логгера
- `info(message: str, class_name: Optional[str] = None, func_name: Optional[str] = None) -> None` - Логирование уровня INFO
- `debug(message: str, class_name: Optional[str] = None, func_name: Optional[str] = None) -> None` - Логирование уровня DEBUG
- `warning(message: str, class_name: Optional[str] = None, func_name: Optional[str] = None) -> None` - Логирование уровня WARNING
- `error(message: str, class_name: Optional[str] = None, func_name: Optional[str] = None) -> None` - Логирование уровня ERROR

### Класс FileProcessor
Класс для обработки Excel файлов.

**Методы:**
- `__init__(input_dir: str = INPUT_DIR, logger_instance: Optional[Logger] = None)` - Инициализация процессора
- `load_all_files() -> None` - Загружает все файлы из подкаталогов
- `collect_unique_tab_numbers() -> None` - Собирает уникальные табельные номера
- `prepare_summary_data() -> pd.DataFrame` - Подготавливает сводные данные

**Пример использования:**
```python
processor = FileProcessor(input_dir="IN", logger_instance=logger)
processor.load_all_files()
processor.collect_unique_tab_numbers()
summary_df = processor.prepare_summary_data()
```

### Класс ExcelFormatter
Класс для форматирования Excel файлов.

**Методы:**
- `__init__(logger_instance: Optional[Logger] = None)` - Инициализация форматтера
- `format_excel_file(file_path: str, sheet_name: str = "Sheet1") -> None` - Форматирует существующий Excel файл
- `create_formatted_excel(df: pd.DataFrame, output_path: str, sheet_name: str = "Данные") -> None` - Создает новый Excel файл с форматированием

**Пример использования:**
```python
formatter = ExcelFormatter(logger_instance=logger)
formatter.create_formatted_excel(df, "output.xlsx", sheet_name="Данные")
```

### Функция main()
Основная функция приложения. Координирует все этапы обработки данных.

## Структура проекта

```
YEAR_SPOD_TOP_Month/
├── main.py                       # Основной файл приложения (все в одном файле)
├── README.md                     # Документация проекта
├── requirements.txt              # Зависимости проекта
├── .gitignore                   # Игнорируемые файлы для Git
├── log/                          # Каталог для логов
├── Docs/                         # Дополнительная документация
├── IN/                           # Входные данные
│   ├── OD/                       # Подкаталог OD (11-12 файлов)
│   ├── RA/                       # Подкаталог RA (11-12 файлов)
│   └── PS/                       # Подкаталог PS (11-12 файлов)
└── OUT/                          # Выходные файлы
```

**Особенности структуры:**
- Все код (конфигурация, логика, форматирование) находится в одном файле `main.py`
- Настройки задаются в начале файла `main.py` как константы
- Документация хранится в папке `Docs`

## Использование

### Установка зависимостей

**Важно:** Программа использует только базовые модули Anaconda. Дополнительная установка пакетов не требуется.

Если у вас установлена Anaconda, то:
- `pandas` обычно уже установлен
- `openpyxl` обычно уже установлен (для форматирования, приоритетный вариант)
- `xlsxwriter` может быть установлен (для форматирования, резервный вариант), но не обязателен

Программа автоматически определяет доступные модули и использует их в порядке приоритета:
1. **openpyxl** (если доступен) - полное форматирование
2. **xlsxwriter** (если доступен) - полное форматирование
3. **Без форматирования** - файл создается, но без форматирования

В любом случае вся функциональность сохраняется.

### Настройка

Откройте файл `main.py` и измените настройки в начале файла:

```python
# Пути к каталогам
INPUT_DIR = "IN"      # Каталог с входными данными
OUTPUT_DIR = "OUT"    # Каталог для выходных файлов
LOG_DIR = "log"       # Каталог для логов

# Уровень логирования (INFO или DEBUG)
LOG_LEVEL = "INFO"    # Измените на "DEBUG" для детального логирования
```

### Запуск

```bash
python main.py
```

### Настройка конфигурации загрузки файлов

По умолчанию для каждой группы (OD, RA, PS) заданы следующие настройки:

**Колонки по умолчанию:**
- Табельный
- ТБ
- ГОСБ
- КМ
- ФИО
- Показатель

**Исключаемые поля:**
- Примечание
- Комментарий

**Обязательные поля:**
- Табельный
- ТБ
- ГОСБ
- ФИО

Для добавления пофайловых настроек отредактируйте функцию `main()` в файле `main.py`:

```python
def main():
    # ... существующий код ...
    
    # Добавляем пофайловую конфигурацию перед загрузкой файлов
    custom_config = FileConfig(
        columns=["Табельный", "ТБ", "ФИО", "Показатель"],
        exclude_fields=["КМ", "ГОСБ"],
        required_fields=["Табельный", "ФИО"]
    )
    config_manager.add_file_config("OD", "special_file.xlsx", custom_config)
    
    # ... остальной код ...
```

## История версий

### Версия 1.0.0
**Дата создания:** 2025-01-XX

**Реализованный функционал:**
- ✅ Создана базовая структура проекта
- ✅ Все компоненты объединены в один файл `main.py`
- ✅ Реализован модуль конфигурации с поддержкой групповых и пофайловых настроек
- ✅ Реализована система логирования с уровнями INFO и DEBUG
- ✅ Реализован модуль загрузки и обработки Excel файлов
- ✅ Реализован сбор уникальных табельных номеров с учетом приоритета данных
- ✅ Реализовано формирование сводных данных с суммированием показателей
- ✅ Реализован модуль форматирования Excel файлов
- ✅ Реализована основная функция приложения

**Технические детали:**
- Проект использует Python 3.8+
- Используются только базовые модули Anaconda: pandas (обязательно), openpyxl (обычно доступен), xlsxwriter (опционально)
- Приоритет форматирования: openpyxl > xlsxwriter > без форматирования
- Все логи сохраняются в каталог `log` с именованием по шаблону
- Конфигурация поддерживает настройки по умолчанию для групп и пофайловые настройки
- Приоритет данных: OD > RA > PS, 12 месяц > 11 месяц > ... > 1 месяц
- Все настройки находятся в начале файла `main.py` как константы
- Если ни openpyxl, ни xlsxwriter недоступны, файл создается без форматирования, но функциональность сохраняется

**Решенные проблемы:**
- Реализована гибкая система конфигурации для различных типов файлов
- Обеспечена корректная обработка отсутствующих колонок
- Реализована проверка обязательных полей
- Оптимизирована обработка больших объемов данных
- Упрощена структура проекта - все в одном файле

## Технические требования

- Python 3.8 или выше
- Anaconda (базовая установка)
- pandas (обычно входит в Anaconda)
- openpyxl (обычно входит в Anaconda - для форматирования, приоритетный вариант)
- xlsxwriter (опционально, если доступен в Anaconda - для форматирования, резервный вариант)
- Excel файлы в формате .xlsx или .xls

**Важно:** Программа разработана для работы только с базовыми модулями Anaconda. Установка дополнительных пакетов через pip не требуется и может быть запрещена политикой безопасности. Программа автоматически определяет доступные модули и использует их в порядке приоритета: openpyxl > xlsxwriter > без форматирования.

## Примечания

- Все файлы должны содержать колонки с табельными номерами, ТБ, ГОСБ, ФИО
- Номер месяца определяется автоматически из имени файла (ищется двузначное число от 1 до 12)
- При отсутствии данных в файле для табельного номера, сумма показателя устанавливается в 0
- Итоговый файл сохраняется с временной меткой в имени для предотвращения перезаписи
- Все настройки находятся в начале файла `main.py` - измените их при необходимости
