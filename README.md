# Обработка месячных данных (YEAR_SPOD_TOP_Month)

## Формулировка задачи и техническое задание

### Задача
Создать систему для автоматической обработки месячных данных из Excel файлов, расположенных в подкаталогах `OD`, `RA` и `PS` внутри каталога `IN`. Система должна:

1. Загружать файлы из всех подкаталогов с учетом настроек для каждой группы
2. Собирать уникальные табельные номера из всех файлов
3. Определять приоритетные данные для каждого табельного номера (ОД > RA > PS, 12 месяц > 11 месяц > ...)
4. Формировать сводный Excel файл с суммированием показателей по каждому файлу
5. Применять форматирование к итоговому файлу согласно требованиям

### Техническое задание

**Входные данные:**
- Каталог `IN` с подкаталогами: `OD`, `RA`, `PS`
- В каждом подкаталоге 12 Excel файлов с месячными данными в формате `M-{номер}_{группа}.xlsx` (например, `M-1_OD.xlsx`, `M-2_RA.xlsx`)
- Номер месяца: 1 (январь) до 12 (декабрь)
- Каждый файл содержит колонки: Табельный номер, Короткое ТБ, Полное ГОСБ, ИНН, ФИО, Факт

**Выходные данные:**
- Excel файл со сводными данными, содержащий два листа:
  - **Лист "Данные"**: Уникальные табельные номера, ТБ, ГОСБ, ФИО (из файла с наивысшим приоритетом), колонки с суммами показателей из каждого файла
  - **Лист "Расчеты"**: Те же базовые колонки (Табельный, ТБ, ГОСБ, ФИО) и расчетные колонки по месяцам с различными типами расчетов (как есть, прирост по 2 месяцам, прирост по трем периодам)

**Требования к форматированию:**
- Первая строка и первые 4 колонки (до ФИО включительно) зафиксированы на обоих листах
- Заголовки жирным шрифтом, размер 12, центрированы
- Ширина колонок: минимум 15, максимум 150
- Подбор ширины по содержимому
- Перенос текста по словам
- Автофильтр включен
- Табельный номер: формат 8 знаков с лидирующими нулями (например, `00000123`)
- Числовые колонки: формат с разделителем разрядов и двумя знаками после запятой (например, `1 234 567,89`)
- Порядок колонок: базовые (Табельный, ТБ, ГОСБ, ФИО), затем по группам и месяцам (OD M-1...M-12, RA M-1...M-12, PS M-1...M-12)

## Подробное описание решения

### Архитектура системы

Все компоненты системы находятся в одном файле `main.py`:

1. **Настройки приложения** - пути к каталогам и уровень логирования
2. **Конфигурация загрузки файлов** - настройки по умолчанию для групп OD, RA, PS и пофайловые настройки
3. **Модуль логирования** - система логирования с уровнями INFO и DEBUG
4. **Модуль обработки файлов** - загрузка и обработка Excel файлов
5. **Модуль форматирования Excel** - форматирование итоговых Excel файлов
6. **Основная функция** - координация всех этапов обработки

### Алгоритм работы

1. **Загрузка файлов:**
   - Сканирование подкаталогов OD, RA, PS
   - Загрузка каждого Excel файла с применением конфигурации группы
   - Фильтрация колонок согласно настройкам
   - Проверка обязательных полей

2. **Сбор уникальных табельных номеров:**
   - Извлечение всех табельных номеров из всех файлов
   - Определение приоритета данных:
     - По группам: OD (приоритет 1) > RA (приоритет 2) > PS (приоритет 3)
     - По месяцам: 12 > 11 > ... > 1
   - Сохранение ТБ, ГОСБ, ФИО из файла с наивысшим приоритетом

3. **Формирование сводных данных:**
   - Для каждого уникального табельного номера
   - Форматирование табельного номера: 8 знаков с лидирующими нулями
   - Сбор сумм показателей из каждого файла
   - Создание структуры: строки = табельные номера, колонки = файлы
   - Упорядочивание колонок: базовые колонки, затем по группам (OD, RA, PS) и месяцам (M-1, M-2, ..., M-12)

4. **Формирование расчетных данных:**
   - Копирование базовых колонок (Табельный, ТБ, ГОСБ, ФИО)
   - Расчет значений по месяцам согласно типу расчета:
     - Тип 1: "Как есть" - просто сумма данных (аналог первого листа)
     - Тип 2: "Прирост по 2 месяцам" - текущий месяц минус предыдущий месяц
     - Тип 3: "Прирост по трем периодам" - М-N = М-N - 2*М-(N-1) + М-(N-2)
   - Обработка первых месяцев согласно правилам для каждого типа расчета

5. **Сохранение и форматирование:**
   - Сохранение данных в Excel на два листа: "Данные" и "Расчеты"
   - Применение форматирования к заголовкам и ячейкам на обоих листах
   - Фиксация первой строки и первых 4 колонок (до ФИО включительно)
   - Форматирование табельного номера: текстовый формат для сохранения лидирующих нулей
   - Форматирование числовых колонок: разделитель разрядов и два знака после запятой
   - Настройка ширины колонок и автофильтра

## Полный список переменных и функций

### Настройки приложения

Все настройки находятся в начале файла `main.py`:

```python
INPUT_DIR = "IN"      # Каталог с входными данными
OUTPUT_DIR = "OUT"     # Каталог для выходных файлов
LOG_DIR = "log"        # Каталог для логов
LOG_LEVEL = "INFO"     # Уровень логирования (INFO или DEBUG)
LOG_THEME = "processor"  # Тема логов
```

### Класс FileConfig
Конфигурация для отдельного файла.

**Поля:**
- `columns: Optional[List[str]]` - Колонки для загрузки (None = использовать настройки группы)
- `exclude_fields: List[str]` - Поля для исключения
- `required_fields: List[str]` - Обязательные поля
- `custom_settings: Dict[str, Any]` - Дополнительные настройки

**Пример использования:**
```python
file_config = FileConfig(
    columns=["Табельный", "ТБ", "ГОСБ", "ФИО", "Показатель"],
    exclude_fields=["Примечание"],
    required_fields=["Табельный", "ФИО"]
)
```

### Класс DefaultsConfig
Настройки по умолчанию для группы файлов. Все эти настройки используются, если в FileItem не указаны индивидуальные значения.

**Поля:**
- `columns: List[Dict[str, str]]` - Колонки по умолчанию (маппинг source -> alias)
- `drop_rules: List[DropRule]` - Правила удаления строк по умолчанию
- `in_rules: List[IncludeRule]` - Правила включения строк по умолчанию
- `tab_number_column: str` - Название колонки с табельным номером (после маппинга)
- `tb_column: str` - Название колонки с ТБ (после маппинга)
- `gosb_column: str` - Название колонки с ГОСБ (после маппинга)
- `fio_column: str` - Название колонки с ФИО (после маппинга)
- `indicator_column: str` - Название колонки с показателем (после маппинга)
- `header_row: Optional[int]` - Номер строки с заголовками
- `skip_rows: int` - Количество строк для пропуска в начале файла
- `skip_footer: int` - Количество строк для пропуска в конце файла
- `sheet_name: Optional[str]` - Название листа для чтения
- `sheet_index: Optional[int]` - Номер листа для чтения
- `calculation_type: int` - Тип расчета для второго листа (1, 2, 3)
- `first_month_value: str` - Значение для первого месяца при расчете типа 2 ("self" или "zero")
- `three_periods_first_months: str` - Правила для первого и второго месяца при расчете типа 3

### Класс FileItem
Элемент конфигурации для одного файла.

**Поля:**
- `key: str` - Ключ файла (для идентификации)
- `label: str` - Подпись для логов
- `file_name: str` - Имя файла в каталоге IN
- `sheet: Optional[str]` - Название листа (если None, используется default_sheet из группы)
- `columns: List[Dict[str, str]]` - Колонки для этого файла (если пустой [], используются из defaults)
- `filters: Dict[str, Any]` - Фильтры для этого файла (drop_rules, in_rules)
- `calculation_type: Optional[int]` - Тип расчета для второго листа (1, 2, 3 или None - использовать default)
- `first_month_value: Optional[str]` - Значение для первого месяца при расчете типа 2 ("self", "zero" или None - использовать default)
- `three_periods_first_months: Optional[str]` - Правила для первого и второго месяца при расчете типа 3 (или None - использовать default)

**Приоритет настроек:** Если параметры расчета указаны в FileItem, они имеют приоритет над значениями из defaults.

### Класс GroupConfig
Конфигурация для группы файлов (OD, RA, PS).

**Поля:**
- `name: str` - Название группы
- `default_sheet: str` - Лист по умолчанию
- `items: List[FileItem]` - Список файлов (items)
- `defaults: DefaultsConfig` - Настройки по умолчанию для этой группы

### Класс ConfigManager
Менеджер конфигурации для управления настройками загрузки файлов.

**Методы:**
- `get_config_for_file(group_name: str, file_name: str) -> Dict[str, Any]` - Получает конфигурацию для конкретного файла
- `add_file_config(group_name: str, file_pattern: str, file_config: FileConfig) -> None` - Добавляет пофайловую конфигурацию
- `get_group_config(group_name: str) -> GroupConfig` - Получает конфигурацию группы

**Пример использования:**
```python
# Получить конфигурацию для файла
config = config_manager.get_config_for_file("OD", "file_12.xlsx")

# Добавить пофайловую конфигурацию
custom_config = FileConfig(
    columns=["Табельный", "ТБ", "ФИО"],
    exclude_fields=["КМ"]
)
config_manager.add_file_config("OD", "special_file.xlsx", custom_config)
```

### Класс Logger
Класс для настройки и управления логированием.

**Методы:**
- `__init__(log_dir: str = LOG_DIR, level: str = LOG_LEVEL, theme: str = LOG_THEME)` - Инициализация логгера
- `info(message: str, class_name: Optional[str] = None, func_name: Optional[str] = None) -> None` - Логирование уровня INFO
- `debug(message: str, class_name: Optional[str] = None, func_name: Optional[str] = None) -> None` - Логирование уровня DEBUG
- `warning(message: str, class_name: Optional[str] = None, func_name: Optional[str] = None) -> None` - Логирование уровня WARNING
- `error(message: str, class_name: Optional[str] = None, func_name: Optional[str] = None) -> None` - Логирование уровня ERROR

### Класс FileProcessor
Класс для обработки Excel файлов.

**Методы:**
- `__init__(input_dir: str = INPUT_DIR, logger_instance: Optional[Logger] = None)` - Инициализация процессора
- `load_all_files() -> None` - Загружает все файлы из подкаталогов
- `collect_unique_tab_numbers() -> None` - Собирает уникальные табельные номера
- `prepare_summary_data() -> pd.DataFrame` - Подготавливает сводные данные для листа "Данные"
- `prepare_calculated_data(summary_df: pd.DataFrame) -> pd.DataFrame` - Подготавливает расчетные данные для листа "Расчеты"

**Пример использования:**
```python
processor = FileProcessor(input_dir="IN", logger_instance=logger)
processor.load_all_files()
processor.collect_unique_tab_numbers()
summary_df = processor.prepare_summary_data()
calculated_df = processor.prepare_calculated_data(summary_df)
```

### Класс ExcelFormatter
Класс для форматирования Excel файлов.

**Методы:**
- `__init__(logger_instance: Optional[Logger] = None)` - Инициализация форматтера
- `format_excel_file(file_path: str, sheet_name: str = "Sheet1") -> None` - Форматирует существующий Excel файл
- `create_formatted_excel(summary_df: pd.DataFrame, calculated_df: pd.DataFrame, output_path: str) -> None` - Создает новый Excel файл с двумя листами ("Данные" и "Расчеты") и форматированием

**Пример использования:**
```python
formatter = ExcelFormatter(logger_instance=logger)
formatter.create_formatted_excel(summary_df, calculated_df, "output.xlsx")
```

### Функция main()
Основная функция приложения. Координирует все этапы обработки данных.

## Структура проекта

```
YEAR_SPOD_TOP_Month/
├── main.py                       # Основной файл приложения (все в одном файле)
├── README.md                     # Документация проекта
├── requirements.txt              # Зависимости проекта
├── .gitignore                   # Игнорируемые файлы для Git
├── log/                          # Каталог для логов
├── Docs/                         # Дополнительная документация
├── IN/                           # Входные данные
│   ├── OD/                       # Подкаталог OD (11-12 файлов)
│   ├── RA/                       # Подкаталог RA (11-12 файлов)
│   └── PS/                       # Подкаталог PS (11-12 файлов)
└── OUT/                          # Выходные файлы
```

**Особенности структуры:**
- Все код (конфигурация, логика, форматирование) находится в одном файле `main.py`
- Настройки задаются в начале файла `main.py` как константы
- Документация хранится в папке `Docs`

## Использование

### Установка зависимостей

**Важно:** Программа использует только базовые модули Anaconda. Дополнительная установка пакетов не требуется.

Если у вас установлена Anaconda, то:
- `pandas` обычно уже установлен
- `openpyxl` обычно уже установлен (для форматирования, приоритетный вариант)
- `xlsxwriter` может быть установлен (для форматирования, резервный вариант), но не обязателен

Программа автоматически определяет доступные модули и использует их в порядке приоритета:
1. **openpyxl** (если доступен) - полное форматирование
2. **xlsxwriter** (если доступен) - полное форматирование
3. **Без форматирования** - файл создается, но без форматирования

В любом случае вся функциональность сохраняется.

### Настройка

Откройте файл `main.py` и измените настройки в начале файла:

```python
# Пути к каталогам
INPUT_DIR = "IN"      # Каталог с входными данными
OUTPUT_DIR = "OUT"    # Каталог для выходных файлов
LOG_DIR = "log"       # Каталог для логов

# Уровень логирования (INFO или DEBUG)
LOG_LEVEL = "INFO"    # Измените на "DEBUG" для детального логирования
```

### Запуск

```bash
python main.py
```

### Настройка конфигурации загрузки файлов

По умолчанию для каждой группы (OD, RA, PS) заданы следующие настройки в блоке `defaults=DefaultsConfig(...)`:

**Колонки по умолчанию:**
- Табельный номер (alias: `tab_number`)
- Короткое ТБ (alias: `tb`)
- Полное ГОСБ (alias: `gosb`)
- ИНН (alias: `client_id`)
- ФИО (alias: `fio`)
- Факт (alias: `indicator`)

**Параметры расчета для второго листа:**
- `calculation_type`: Тип расчета (1 - как есть, 2 - прирост по 2 месяцам, 3 - прирост по трем периодам)
- `first_month_value`: Значение для первого месяца при расчете типа 2 ("self" - равен самому себе, "zero" - равен 0)
- `three_periods_first_months`: Правила для первого и второго месяца при расчете типа 3 ("zero_both", "zero_first_diff_second", "self_first_diff_second")

**Индивидуальные настройки для файлов:**

Параметры расчета можно задавать для каждого файла индивидуально в `FileItem`. Если параметры не указаны (None), используются значения из `defaults`.

Примеры:
```python
# Использовать default значения
FileItem(key="OD_01", ..., calculation_type=None, first_month_value=None, three_periods_first_months=None)

# Задать индивидуальные значения для конкретного файла
FileItem(key="OD_01", ..., calculation_type=2, first_month_value="zero")  # Тип 2, первый месяц = 0
FileItem(key="OD_02", ..., calculation_type=3, three_periods_first_months="self_first_diff_second")  # Тип 3 с особыми правилами
```

Для изменения настроек по умолчанию отредактируйте блок `defaults=DefaultsConfig(...)` в функции `_create_default_configs()` в файле `main.py`.

## История версий

### Версия 1.2.0
**Дата:** 2025-01-XX

**Новые возможности:**
- ✅ Добавлен второй лист "Расчеты" в выходной Excel файл
- ✅ Реализованы три типа расчетов для второго листа:
  * Тип 1: "Как есть" - просто сумма данных (аналог первого листа)
  * Тип 2: "Прирост по 2 месяцам" - текущий месяц минус предыдущий месяц
  * Тип 3: "Прирост по трем периодам" - М-N = М-N - 2*М-(N-1) + М-(N-2)
- ✅ Добавлена возможность задавать параметры расчета для каждого файла индивидуально в `FileItem`
- ✅ Реализована структура `DefaultsConfig` для консолидации всех настроек по умолчанию в одном блоке
- ✅ Добавлена фиксация первой строки и первых 4 колонок (до ФИО включительно) на обоих листах
- ✅ Обновлена структура конфигурации: все default настройки собраны в блок `defaults=DefaultsConfig(...)`

**Технические детали:**
- Параметры расчета (`calculation_type`, `first_month_value`, `three_periods_first_months`) можно задавать как в `defaults`, так и для каждого `FileItem` индивидуально
- Если параметры не указаны в `FileItem` (None), используются значения из `defaults`
- Правила для первых месяцев при расчете типа 3: "zero_both", "zero_first_diff_second", "self_first_diff_second"
- Значение для первого месяца при расчете типа 2: "self" (равен самому себе) или "zero" (равен 0)

### Версия 1.1.0
**Дата:** 2025-01-XX

**Новые возможности:**
- ✅ Обновлены имена файлов на формат `M-{номер}_{группа}.xlsx` (M-1_OD.xlsx, M-2_RA.xlsx и т.д.)
- ✅ Обновлены имена колонок в конфигурации:
  * Табельный → Табельный номер
  * ТБ → Короткое ТБ
  * ГОСБ → Полное ГОСБ
  * КМ → ИНН (client_id)
  * Показатель → Факт
- ✅ Унифицированы имена колонок во всех трех группах (OD, RA, PS)
- ✅ Добавлено упорядочивание колонок по месяцам (M-1, M-2, ..., M-12) для каждой группы
- ✅ Добавлено числовое форматирование: разделитель разрядов и два знака после запятой
- ✅ Добавлено форматирование табельного номера: 8 знаков с лидирующими нулями
- ✅ Обновлена функция `extract_month_number` для поддержки нового формата имен файлов

**Технические детали:**
- Порядок колонок в итоговом файле: базовые (Табельный, ТБ, ГОСБ, ФИО), затем OD M-1...M-12, RA M-1...M-12, PS M-1...M-12
- Табельный номер форматируется как текст с лидирующими нулями (формат `@` в Excel)
- Числовые колонки используют формат `#,##0.00` (разделитель разрядов и два знака после запятой)

### Версия 1.0.0
**Дата создания:** 2025-01-XX

**Реализованный функционал:**
- ✅ Создана базовая структура проекта
- ✅ Все компоненты объединены в один файл `main.py`
- ✅ Реализован модуль конфигурации с поддержкой групповых и пофайловых настроек
- ✅ Реализована система логирования с уровнями INFO и DEBUG
- ✅ Реализован модуль загрузки и обработки Excel файлов
- ✅ Реализован сбор уникальных табельных номеров с учетом приоритета данных
- ✅ Реализовано формирование сводных данных с суммированием показателей
- ✅ Реализован модуль форматирования Excel файлов
- ✅ Реализована основная функция приложения

**Технические детали:**
- Проект использует Python 3.8+
- Используются только базовые модули Anaconda: pandas (обязательно), openpyxl (обычно доступен), xlsxwriter (опционально)
- Приоритет форматирования: openpyxl > xlsxwriter > без форматирования
- Все логи сохраняются в каталог `log` с именованием по шаблону
- Конфигурация поддерживает настройки по умолчанию для групп и пофайловые настройки
- Приоритет данных: OD > RA > PS, 12 месяц > 11 месяц > ... > 1 месяц
- Все настройки находятся в начале файла `main.py` как константы
- Если ни openpyxl, ни xlsxwriter недоступны, файл создается без форматирования, но функциональность сохраняется

**Решенные проблемы:**
- Реализована гибкая система конфигурации для различных типов файлов
- Обеспечена корректная обработка отсутствующих колонок
- Реализована проверка обязательных полей
- Оптимизирована обработка больших объемов данных
- Упрощена структура проекта - все в одном файле

## Технические требования

- Python 3.8 или выше
- Anaconda (базовая установка)
- pandas (обычно входит в Anaconda)
- openpyxl (обычно входит в Anaconda - для форматирования, приоритетный вариант)
- xlsxwriter (опционально, если доступен в Anaconda - для форматирования, резервный вариант)
- Excel файлы в формате .xlsx или .xls

**Важно:** Программа разработана для работы только с базовыми модулями Anaconda. Установка дополнительных пакетов через pip не требуется и может быть запрещена политикой безопасности. Программа автоматически определяет доступные модули и использует их в порядке приоритета: openpyxl > xlsxwriter > без форматирования.

## Примечания

- Все файлы должны содержать колонки: Табельный номер, Короткое ТБ, Полное ГОСБ, ИНН, ФИО, Факт
- Имена файлов должны быть в формате `M-{номер}_{группа}.xlsx`, где номер месяца от 1 (январь) до 12 (декабрь)
- Номер месяца определяется автоматически из имени файла (формат `M-{номер}_`)
- Поддерживается альтернативная нумерация T-11 (январь) до T-0 (декабрь)
- Табельный номер автоматически форматируется как 8 знаков с лидирующими нулями
- При отсутствии данных в файле для табельного номера, сумма показателя устанавливается в 0
- Итоговый файл содержит два листа: "Данные" (суммы по месяцам) и "Расчеты" (расчетные значения согласно типу расчета)
- Итоговый файл сохраняется с временной меткой в имени для предотвращения перезаписи
- Все настройки находятся в начале файла `main.py` - измените их при необходимости
- Числовые значения в итоговом файле отображаются с разделителем разрядов и двумя знаками после запятой
- Параметры расчета можно задавать как в `defaults` (для всей группы), так и для каждого `FileItem` индивидуально
- Первая строка и первые 4 колонки (до ФИО включительно) зафиксированы на обоих листах для удобства просмотра
